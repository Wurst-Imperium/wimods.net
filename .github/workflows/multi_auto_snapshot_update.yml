name: Run Auto Snapshot Update Workflows

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: "Target Minecraft version (leave blank to auto detect)"
        required: false
      branch:
        description: "Branch for the current snapshot cycle (leave blank to auto detect)"
        required: false
      cf_game_version:
        description: "CurseForge game version (leave blank to auto detect)"
        required: false
      fapi_version:
        description: "Fabric API version (leave blank to auto detect)"
        required: false
      include_wurst:
        description: "Include Wurst Client"
        type: boolean
        required: false
        default: true
      include_wi_zoom:
        description: "Include WI Zoom"
        type: boolean
        required: false
        default: true
      include_mo_glass:
        description: "Include Mo Glass"
        type: boolean
        required: false
        default: true
      auto_publish:
        description: "Automatically publish mods that were successfully updated"
        type: boolean
        required: false
        default: false

jobs:

  get_params:
    runs-on: ubuntu-latest
    outputs:
      mc_version: ${{ steps.get_mc_versions.outputs.mc_version }}
      branch: ${{ steps.get_snapshot_cycle_info.outputs.branch }}
      cf_game_version: ${{ steps.get_snapshot_cycle_info.outputs.cf_game_version }}
      yarn_version: ${{ steps.get_yarn_and_loader.outputs.yarn_version }}
      loader_version: ${{ steps.get_yarn_and_loader.outputs.loader_version }}
      fapi_version: ${{ steps.get_fapi_version.outputs.fapi_version }}
    steps:
    - name: Get target MC version
      id: get_mc_versions
      run: |
        MC_VERSION="${{ inputs.mc_version }}"
        if [ -z "$MC_VERSION" ]; then
          RESPONSE=$(curl -s https://launchermeta.mojang.com/mc/game/version_manifest.json)
          MC_VERSION=$(echo "$RESPONSE" | jq -r '.latest.snapshot')
          if [ -z "$MC_VERSION" ]; then
            echo "No latest Minecraft snapshot found"
            echo "Response: $RESPONSE"
            exit 1
          fi
        fi
        echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT
        echo "Minecraft version: \`$MC_VERSION\`" >> $GITHUB_STEP_SUMMARY
    - name: Get snapshot cycle info
      id: get_snapshot_cycle_info
      run: |
        BRANCH="${{ inputs.branch }}"
        CF_GAME_VERSION="${{ inputs.cf_game_version }}"
        if [ -z "$BRANCH" ] || [ -z "$CF_GAME_VERSION" ]; then
          RESPONSE=$(curl -s https://raw.githubusercontent.com/Wurst-Imperium/wimods.net/refs/heads/master/data/current_snapshot_cycle.json)
          if [ -z "$BRANCH" ]; then
            BRANCH=$(echo "$RESPONSE" | jq -r '.target_release')
          fi
          if [ -z "$CF_GAME_VERSION" ]; then
            CF_GAME_VERSION=$(echo "$RESPONSE" | jq -r '.curseforge_game_version')
          fi
        fi
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
        echo "cf_game_version=$CF_GAME_VERSION" >> $GITHUB_OUTPUT
        echo "CurseForge game version: \`$CF_GAME_VERSION\`" >> $GITHUB_STEP_SUMMARY
    - name: Get Yarn and Loader versions
      id: get_yarn_and_loader
      run: |
        RESPONSE=$(curl -s \
          "https://meta.fabricmc.net/v1/versions/loader/${{ steps.get_mc_versions.outputs.mc_version }}")
        if [ "$(echo "$RESPONSE" | jq length)" -gt 0 ]; then
          YARN_VERSION=$(echo "$RESPONSE" | jq -r '.[0].mappings.version')
          LOADER_VERSION=$(echo "$RESPONSE" | jq -r '.[0].loader.version')
          echo "yarn_version=$YARN_VERSION" >> $GITHUB_OUTPUT
          echo "loader_version=$LOADER_VERSION" >> $GITHUB_OUTPUT
          echo "Yarn version: \`$YARN_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "Loader version: \`$LOADER_VERSION\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "No yarn/loader versions found for ${{ steps.get_mc_versions.outputs.mc_version }}"
          echo "Response: $RESPONSE"
          exit 1
        fi
    - name: Get Fabric API version
      id: get_fapi_version
      run: |
        FAPI_VERSION="${{ inputs.fapi_version }}"
        if [ -z "$FAPI_VERSION" ]; then
          MC_VERSION="${{ steps.get_mc_versions.outputs.mc_version }}"
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "GitHub token is not set"
            exit 1
          fi
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/FabricMC/fabric/releases?per_page=100")
          FAPI_VERSION=$(echo "$RESPONSE" \
            | jq -r --arg MC_VERSION "$MC_VERSION" \
            '.[] | select(.name | contains($MC_VERSION)) | .tag_name' \
            | head -n 1)
          if [ -z "$FAPI_VERSION" ]; then
            echo "No Fabric API version found for $MC_VERSION"
            echo "Response: $RESPONSE"
            exit 1
          fi
        fi
        echo "fapi_version=$FAPI_VERSION" >> $GITHUB_OUTPUT
        echo "Fabric API version: \`$FAPI_VERSION\`" >> $GITHUB_STEP_SUMMARY

  wurst:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_wurst }}
    steps:
    - name: Build Wurst update inputs
      id: wurst_inputs
      run: |
        JSON_STRING=$(cat << EOF
        {
          "mc_version": "${{ needs.get_params.outputs.mc_version }}",
          "yarn_mappings": "${{ needs.get_params.outputs.yarn_version }}",
          "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
          "fapi_version": "${{ needs.get_params.outputs.fapi_version }}"
        }
        EOF
        )
        # Convert to single line and escape quotes
        echo "json=${JSON_STRING//$'\n'/}" >> $GITHUB_OUTPUT
    - name: Trigger snapshot update workflow
      id: wurst_dispatch
      uses: codex-/return-dispatch@v2
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Wurst7
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: ${{ steps.wurst_inputs.outputs.json }}
    - name: Wait for snapshot update workflow to finish (run ${{ steps.wurst_dispatch.outputs.run_id }})
      uses: codex-/await-remote-run@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Wurst7
        run_id: ${{ steps.wurst_dispatch.outputs.run_id }}
        run_timeout_seconds: 1200  # 20 minutes

  wi_zoom:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_wi_zoom }}
    steps:
    - name: Build WI Zoom update inputs
      id: wi_zoom_inputs
      run: |
        JSON_STRING=$(cat << EOF
        {
          "mc_version": "${{ needs.get_params.outputs.mc_version }}",
          "yarn_mappings": "${{ needs.get_params.outputs.yarn_version }}",
          "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
          "fapi_version": "${{ needs.get_params.outputs.fapi_version }}",
          "cf_game_version": "${{ needs.get_params.outputs.cf_game_version }}"
        }
        EOF
        )
        # Convert to single line and escape quotes
        echo "json=${JSON_STRING//$'\n'/}" >> $GITHUB_OUTPUT
    - name: Trigger snapshot update workflow
      id: wi_zoom_dispatch
      uses: codex-/return-dispatch@v2
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: WI-Zoom
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: ${{ steps.wi_zoom_inputs.outputs.json }}
    - name: Wait for snapshot update workflow to finish (run ${{ steps.wi_zoom_dispatch.outputs.run_id }})
      uses: codex-/await-remote-run@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: WI-Zoom
        run_id: ${{ steps.wi_zoom_dispatch.outputs.run_id }}
        run_timeout_seconds: 1200  # 20 minutes

  mo_glass:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_mo_glass }}
    steps:
    - name: Build Mo Glass update inputs
      id: mo_glass_inputs
      run: |
        JSON_STRING=$(cat << EOF
        {
          "mc_version": "${{ needs.get_params.outputs.mc_version }}",
          "yarn_mappings": "${{ needs.get_params.outputs.yarn_version }}",
          "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
          "fapi_version": "${{ needs.get_params.outputs.fapi_version }}",
          "cf_game_version": "${{ needs.get_params.outputs.cf_game_version }}"
        }
        EOF
        )
        # Convert to single line and escape quotes
        echo "json=${JSON_STRING//$'\n'/}" >> $GITHUB_OUTPUT
    - name: Trigger snapshot update workflow
      id: mo_glass_dispatch
      uses: codex-/return-dispatch@v2
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Mo-Glass
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: ${{ steps.mo_glass_inputs.outputs.json }}
    - name: Wait for snapshot update workflow to finish (run ${{ steps.mo_glass_dispatch.outputs.run_id }})
      uses: codex-/await-remote-run@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Mo-Glass
        run_id: ${{ steps.mo_glass_dispatch.outputs.run_id }}
        run_timeout_seconds: 1200  # 20 minutes

  auto_publish:
    runs-on: ubuntu-latest
    needs: [get_params, wurst, wi_zoom, mo_glass]
    if: ${{ !cancelled() && inputs.auto_publish && (needs.wurst.result == 'success' || needs.wi_zoom.result == 'success' || needs.mo_glass.result == 'success') }}
    steps:
    - name: Build publish workflow inputs
      id: publish_inputs
      run: |
        # Determine which mods succeeded and should be published
        INCLUDE_WURST="false"
        INCLUDE_WI_ZOOM="false"
        INCLUDE_MO_GLASS="false"
        
        if [[ "${{ needs.wurst.result }}" == "success" ]]; then
          INCLUDE_WURST="true"
        fi
        if [[ "${{ needs.wi_zoom.result }}" == "success" ]]; then
          INCLUDE_WI_ZOOM="true"
        fi
        if [[ "${{ needs.mo_glass.result }}" == "success" ]]; then
          INCLUDE_MO_GLASS="true"
        fi
        
        JSON_STRING=$(cat << EOF
        {
          "mc_version": "${{ needs.get_params.outputs.mc_version }}",
          "branch": "${{ needs.get_params.outputs.branch }}",
          "include_wurst": "$INCLUDE_WURST",
          "include_wi_zoom": "$INCLUDE_WI_ZOOM",
          "include_mo_glass": "$INCLUDE_MO_GLASS",
          "announce": "true",
          "announce_only": "false"
        }
        EOF
        )
        # Convert to single line and escape quotes
        echo "json=${JSON_STRING//$'\n'/}" >> $GITHUB_OUTPUT
        
        # Add summary of what will be published
        echo "Auto-publishing mods that were successfully updated:" >> $GITHUB_STEP_SUMMARY
        if [[ "$INCLUDE_WURST" == "true" ]]; then
          echo "- ✅ Wurst Client" >> $GITHUB_STEP_SUMMARY
        fi
        if [[ "$INCLUDE_WI_ZOOM" == "true" ]]; then
          echo "- ✅ WI Zoom" >> $GITHUB_STEP_SUMMARY
        fi
        if [[ "$INCLUDE_MO_GLASS" == "true" ]]; then
          echo "- ✅ Mo Glass" >> $GITHUB_STEP_SUMMARY
        fi
    - name: Trigger publish snapshot ports workflow
      id: publish_dispatch
      uses: codex-/return-dispatch@v2
      with:
        token: ${{ github.token }}
        owner: Wurst-Imperium
        repo: wimods.net
        ref: master
        workflow: publish_snapshot_ports.yml
        workflow_inputs: ${{ steps.publish_inputs.outputs.json }}
    - name: Wait for publish workflow to finish (run ${{ steps.publish_dispatch.outputs.run_id }})
      uses: codex-/await-remote-run@v1
      with:
        token: ${{ github.token }}
        owner: Wurst-Imperium
        repo: wimods.net
        run_id: ${{ steps.publish_dispatch.outputs.run_id }}
        run_timeout_seconds: 1200  # 20 minutes
