name: Run Auto Snapshot Update Workflows

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: "Target Minecraft version (leave blank to auto detect)"
        required: false
      branch:
        description: "Branch for the current snapshot cycle (leave blank to auto detect)"
        required: false
      cf_game_version:
        description: "CurseForge game version (leave blank to auto detect)"
        required: false
      fapi_version:
        description: "Fabric API version (leave blank to auto detect)"
        required: false
      include_wurst:
        description: "Include Wurst Client"
        type: boolean
        required: false
        default: true
      include_wi_zoom:
        description: "Include WI Zoom"
        type: boolean
        required: false
        default: true
      include_mo_glass:
        description: "Include Mo Glass"
        type: boolean
        required: false
        default: true
      auto_publish:
        description: "Automatically publish mods that were successfully updated"
        type: boolean
        required: false
        default: false

jobs:

  get_params:
    runs-on: ubuntu-latest
    outputs:
      mc_version: ${{ steps.get_mc_versions.outputs.mc_version }}
      branch: ${{ steps.get_snapshot_cycle_info.outputs.branch }}
      cf_game_version: ${{ steps.get_snapshot_cycle_info.outputs.cf_game_version }}
      loader_version: ${{ steps.get_loader_version.outputs.loader_version }}
      fapi_version: ${{ steps.get_fapi_version.outputs.fapi_version }}
    steps:
    - name: Get target MC version
      id: get_mc_versions
      run: |
        MC_VERSION="${{ inputs.mc_version }}"
        if [ -z "$MC_VERSION" ]; then
          RESPONSE=$(curl -s https://launchermeta.mojang.com/mc/game/version_manifest.json)
          MC_VERSION=$(echo "$RESPONSE" | jq -r '.latest.snapshot')
          if [ -z "$MC_VERSION" ]; then
            echo "No latest Minecraft snapshot found"
            echo "Response: $RESPONSE"
            exit 1
          fi
        fi
        echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT
        echo "Minecraft version: \`$MC_VERSION\`" >> $GITHUB_STEP_SUMMARY
    - name: Get snapshot cycle info
      id: get_snapshot_cycle_info
      run: |
        BRANCH="${{ inputs.branch }}"
        CF_GAME_VERSION="${{ inputs.cf_game_version }}"
        if [ -z "$BRANCH" ] || [ -z "$CF_GAME_VERSION" ]; then
          RESPONSE=$(curl -s https://raw.githubusercontent.com/Wurst-Imperium/wimods.net/refs/heads/master/data/current_snapshot_cycle.json)
          if [ -z "$BRANCH" ]; then
            BRANCH=$(echo "$RESPONSE" | jq -r '.target_release')
          fi
          if [ -z "$CF_GAME_VERSION" ]; then
            CF_GAME_VERSION=$(echo "$RESPONSE" | jq -r '.curseforge_game_version')
          fi
        fi
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
        echo "cf_game_version=$CF_GAME_VERSION" >> $GITHUB_OUTPUT
        echo "CurseForge game version: \`$CF_GAME_VERSION\`" >> $GITHUB_STEP_SUMMARY
    - name: Get Loader version
      id: get_loader_version
      run: |
        RESPONSE=$(curl -s \
          "https://meta.fabricmc.net/v2/versions/loader/${{ steps.get_mc_versions.outputs.mc_version }}")
        if [ "$(echo "$RESPONSE" | jq length)" -gt 0 ]; then
          LOADER_VERSION=$(echo "$RESPONSE" | jq -r '.[0].loader.version')
          echo "loader_version=$LOADER_VERSION" >> $GITHUB_OUTPUT
          echo "Loader version: \`$LOADER_VERSION\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "No loader version found for ${{ steps.get_mc_versions.outputs.mc_version }}"
          echo "Response: $RESPONSE"
          exit 1
        fi
    - name: Get Fabric API version
      id: get_fapi_version
      run: |
        FAPI_VERSION="${{ inputs.fapi_version }}"
        if [ -z "$FAPI_VERSION" ]; then
          TARGET_RELEASE="${{ steps.get_snapshot_cycle_info.outputs.branch }}"
          RESPONSE=$(curl -sL \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/FabricMC/fabric-api/releases?per_page=100")
          FAPI_VERSION=$(echo "$RESPONSE" \
            | jq -r --arg SUFFIX "+$TARGET_RELEASE" \
            '.[] | select(.tag_name | endswith($SUFFIX)) | .tag_name' \
            | head -n 1)
          if [ -z "$FAPI_VERSION" ]; then
            echo "No Fabric API version found ending with +$TARGET_RELEASE"
            echo "Response: $RESPONSE"
            exit 1
          fi
        fi
        echo "fapi_version=$FAPI_VERSION" >> $GITHUB_OUTPUT
        echo "Fabric API version: \`$FAPI_VERSION\`" >> $GITHUB_STEP_SUMMARY
    - name: Mark workflow as started
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.WI_BACKUPS_API_KEY }}" \
          -d "{\"mc_version\": \"${{ steps.get_mc_versions.outputs.mc_version }}\", \"run_id\": \"${{ github.run_id }}\"}" \
          https://api.wurstclient.net/webhooks/snapshot/auto_update_started

  wurst:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_wurst }}
    steps:
    - name: Trigger snapshot update workflow
      uses: Wurst-Imperium/dispatch-and-wait@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Wurst7
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: |
          {
            "mc_version": "${{ needs.get_params.outputs.mc_version }}",
            "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
            "fapi_version": "${{ needs.get_params.outputs.fapi_version }}"
          }
        run_timeout_seconds: 1200  # 20 minutes

  wi_zoom:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_wi_zoom }}
    steps:
    - name: Trigger snapshot update workflow
      uses: Wurst-Imperium/dispatch-and-wait@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: WI-Zoom
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: |
          {
            "mc_version": "${{ needs.get_params.outputs.mc_version }}",
            "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
            "fapi_version": "${{ needs.get_params.outputs.fapi_version }}",
            "cf_game_version": "${{ needs.get_params.outputs.cf_game_version }}"
          }
        run_timeout_seconds: 1200  # 20 minutes

  mo_glass:
    runs-on: ubuntu-latest
    needs: get_params
    if: ${{ inputs.include_mo_glass }}
    steps:
    - name: Trigger snapshot update workflow
      uses: Wurst-Imperium/dispatch-and-wait@v1
      with:
        token: ${{ secrets.SNAPSHOT_MODS_ACTIONS_TOKEN }}
        owner: Wurst-Imperium
        repo: Mo-Glass
        ref: ${{ needs.get_params.outputs.branch }}
        workflow: auto_snapshot_update.yml
        workflow_inputs: |
          {
            "mc_version": "${{ needs.get_params.outputs.mc_version }}",
            "fabric_loader": "${{ needs.get_params.outputs.loader_version }}",
            "fapi_version": "${{ needs.get_params.outputs.fapi_version }}",
            "cf_game_version": "${{ needs.get_params.outputs.cf_game_version }}"
          }
        run_timeout_seconds: 1200  # 20 minutes

  auto_publish:
    runs-on: ubuntu-latest
    needs: [get_params, wurst, wi_zoom, mo_glass]
    if: ${{ !cancelled() && inputs.auto_publish && (needs.wurst.result == 'success' || needs.wi_zoom.result == 'success' || needs.mo_glass.result == 'success') }}
    steps:
    - name: Build publish workflow inputs
      id: publish_inputs
      run: |
        echo "include_wurst=$([[ "${{ needs.wurst.result }}" == "success" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "include_wi_zoom=$([[ "${{ needs.wi_zoom.result }}" == "success" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "include_mo_glass=$([[ "${{ needs.mo_glass.result }}" == "success" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
    - name: Trigger publish snapshot ports workflow
      uses: Wurst-Imperium/dispatch-and-wait@v1
      with:
        token: ${{ github.token }}
        owner: Wurst-Imperium
        repo: wimods.net
        ref: master
        workflow: publish_snapshot_ports.yml
        workflow_inputs: |
          {
            "mc_version": "${{ needs.get_params.outputs.mc_version }}",
            "branch": "${{ needs.get_params.outputs.branch }}",
            "include_wurst": "${{ steps.publish_inputs.outputs.include_wurst }}",
            "include_wi_zoom": "${{ steps.publish_inputs.outputs.include_wi_zoom }}",
            "include_mo_glass": "${{ steps.publish_inputs.outputs.include_mo_glass }}",
            "announce": "true",
            "announce_only": "false"
          }
        run_timeout_seconds: 1200  # 20 minutes
